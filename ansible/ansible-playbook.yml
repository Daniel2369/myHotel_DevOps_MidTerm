---
- name: Bootstrap Kubernetes Cluster
  hosts: all
  become: yes
  vars_files:
    - ansible_vars.json
  vars:
    region: "us-east-1"
    ansible_user: ubuntu
    kube_version: "1.28"

  tasks:
    - name: Wait for apt locks
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock /var/lib/apt/lists/lock /var/cache/apt/archives/lock >/dev/null 2>&1; do
          sleep 5
        done
      changed_when: false

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Install base dependencies
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - gnupg
          - apt-transport-https
          - ca-certificates
          - unzip
          - awscli
        state: present

    - name: Setup AWS credentials
      ansible.builtin.copy:
        dest: "/home/ubuntu/.aws/credentials"
        content: |
          [default]
          aws_access_key_id={{ aws_access_key_id }}
          aws_secret_access_key={{ aws_secret_access_key }}
          aws_session_token={{ aws_session_token }}
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Copy credentials for root
      ansible.builtin.copy:
        src: "/home/ubuntu/.aws/credentials"
        dest: "/root/.aws/credentials"
        owner: root
        group: root
        mode: '0600'

- name: Install Kubernetes Control Plane
  hosts: myhotel_ec2[0]
  become: yes
  vars:
    ansible_user: ubuntu

  tasks:
    - name: Set hostname
      ansible.builtin.hostname:
        name: k8s-controller

    - name: Disable SWAP
      ansible.builtin.shell: |
        swapoff -a
        sed -i '/ swap / s/^/#/' /etc/fstab

    - name: Load kernel modules
      ansible.builtin.shell: |
        echo "overlay" > /etc/modules-load.d/k8s.conf
        echo "br_netfilter" >> /etc/modules-load.d/k8s.conf
        modprobe overlay
        modprobe br_netfilter

    - name: Configure network settings
      ansible.builtin.copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
        mode: '0644'
      notify: apply sysctl

    - name: Apply network settings
      ansible.builtin.shell: sysctl --system
      changed_when: false

    - name: Install containerd
      ansible.builtin.apt:
        name: containerd
        state: present

    - name: Configure containerd
      ansible.builtin.shell: |
        mkdir -p /etc/containerd
        containerd config default | tee /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

    - name: Restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        enabled: yes

    - name: Setup Kubernetes repository
      ansible.builtin.shell: |
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ kube_version }}/deb/Release.key | \
          gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kube_version }}/deb/ /" | \
          tee /etc/apt/sources.list.d/kubernetes.list

    - name: Install Kubernetes components
      ansible.builtin.apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages
      ansible.builtin.shell: apt-mark hold kubelet kubeadm kubectl
      changed_when: false

    - name: Reset kubeadm if already initialized
      ansible.builtin.shell: |
        if [ -f /etc/kubernetes/admin.conf ]; then
          kubeadm reset -f || true
        fi
      failed_when: false

    - name: Initialize Kubernetes control plane
      ansible.builtin.shell: |
        kubeadm init --pod-network-cidr=10.244.0.0/16

    - name: Configure kubectl
      ansible.builtin.shell: |
        mkdir -p /home/ubuntu/.kube /root/.kube
        cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
        cp /etc/kubernetes/admin.conf /root/.kube/config
        chown -R ubuntu:ubuntu /home/ubuntu/.kube

    - name: Install Calico network plugin
      ansible.builtin.shell: |
        kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml

    - name: Wait for Calico to be ready
      ansible.builtin.pause:
        seconds: 60

    - name: Generate join command
      ansible.builtin.shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubeadm token create --print-join-command > /home/ubuntu/worker-join-command.sh
        chmod 755 /home/ubuntu/worker-join-command.sh

- name: Install Kubernetes Worker Nodes
  hosts: myhotel_ec2[1:]
  become: yes
  vars:
    ansible_user: ubuntu

  tasks:
    - name: Set hostname
      ansible.builtin.hostname:
        name: "k8s-worker-{{ inventory_hostname_short }}"

    - name: Disable SWAP
      ansible.builtin.shell: |
        swapoff -a
        sed -i '/ swap / s/^/#/' /etc/fstab

    - name: Load kernel modules
      ansible.builtin.shell: |
        echo "overlay" > /etc/modules-load.d/k8s.conf
        echo "br_netfilter" >> /etc/modules-load.d/k8s.conf
        modprobe overlay
        modprobe br_netfilter

    - name: Configure network settings
      ansible.builtin.copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
        mode: '0644'

    - name: Apply network settings
      ansible.builtin.shell: sysctl --system
      changed_when: false

    - name: Install containerd
      ansible.builtin.apt:
        name: containerd
        state: present

    - name: Configure containerd
      ansible.builtin.shell: |
        mkdir -p /etc/containerd
        containerd config default | tee /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

    - name: Restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        enabled: yes

    - name: Setup Kubernetes repository
      ansible.builtin.shell: |
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ kube_version }}/deb/Release.key | \
          gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kube_version }}/deb/ /" | \
          tee /etc/apt/sources.list.d/kubernetes.list

    - name: Install Kubernetes components
      ansible.builtin.apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages
      ansible.builtin.shell: apt-mark hold kubelet kubeadm kubectl
      changed_when: false

    - name: Wait for control plane to be ready
      ansible.builtin.pause:
        seconds: 30

    - name: Reset kubeadm if needed
      ansible.builtin.shell: |
        if [ -f /etc/kubernetes/kubelet.conf ]; then
          kubeadm reset -f || true
        fi
      failed_when: false

    - name: Get join command from control plane
      ansible.builtin.slurp:
        src: /home/ubuntu/worker-join-command.sh
      delegate_to: "{{ groups['myhotel_ec2'][0] }}"
      register: join_command_content
      until: join_command_content.content is defined and join_command_content.content | length > 0
      retries: 10
      delay: 5

    - name: Join node to cluster
      ansible.builtin.shell: "{{ join_command_content.content | b64decode | trim }}"

    - name: Verify node joined
      ansible.builtin.shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        sleep 10
        kubectl get nodes | grep -q "{{ ansible_hostname }}.*Ready" && echo "READY" || echo "NOT_READY"
      delegate_to: "{{ groups['myhotel_ec2'][0] }}"
      register: node_status
      until: "'READY' in node_status.stdout"
      retries: 30
      delay: 10
      failed_when: false

- name: Install Helm on Control Plane
  hosts: myhotel_ec2[0]
  become: yes
  vars:
    ansible_user: ubuntu

  tasks:
    - name: Install Helm
      ansible.builtin.shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Wait for all nodes to be ready
      ansible.builtin.shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl wait --for=condition=Ready nodes --all --timeout=300s

- name: Deploy Helm Chart (Optional)
  hosts: myhotel_ec2[0]
  become: yes
  vars:
    ansible_user: ubuntu
    deploy_helm_chart: false

  tasks:
    - name: Copy Helm chart
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/helm-charts/myhotel-app"
        dest: /home/ubuntu/helm-charts/myhotel-app
        mode: preserve
      when: deploy_helm_chart | bool

    - name: Deploy Helm chart
      ansible.builtin.shell: |
        cd /home/ubuntu/helm-charts
        helm install myhotel-app ./myhotel-app --wait --timeout 10m
      when: deploy_helm_chart | bool
