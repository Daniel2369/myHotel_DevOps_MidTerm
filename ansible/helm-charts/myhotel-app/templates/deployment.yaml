apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "myhotel-app.fullname" . }}
  labels:
    {{- include "myhotel-app.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.app.replicaCount }}
  selector:
    matchLabels:
      {{- include "myhotel-app.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "myhotel-app.selectorLabels" . | nindent 8 }}
    spec:
      initContainers:
      - name: wait-for-nfs-server
        image: busybox:latest
        command: ['sh', '-c']
        args:
          - |
            echo "Waiting for NFS server to be ready..."
            NFS_SERVER="{{ .Values.nfsServer.serverIP }}"
            MAX_ATTEMPTS=60
            ATTEMPT=0
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              # Check NFS (2049) and rpcbind (111) - mountd will use dynamic port via rpcbind
              if nc -z $NFS_SERVER 2049 && nc -z $NFS_SERVER 111; then
                echo "NFS server is ready (ports 2049 and 111 accessible)!"
                echo "mountd will be discovered via rpcbind on port 111"
                break
              else
                echo "NFS server not ready yet, waiting... (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
              fi
              sleep 2
              ATTEMPT=$((ATTEMPT+1))
            done
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "Warning: NFS server check timed out, but proceeding..."
            fi
            echo "Proceeding with NFS mount..."
            sleep 3
      {{- if .Values.hotelRoomsJson.enabled }}
      - name: copy-hotel-rooms-json
        image: busybox:latest
        command: ['sh', '-c']
        args:
          - |
            echo "Copying hotel rooms JSON file to NFS volume..."
            mkdir -p /app/data
            cp /config/{{ .Values.hotelRoomsJson.fileName }} /app/data/{{ .Values.hotelRoomsJson.fileName }}
            ls -la /app/data/
            echo "Hotel rooms JSON file copied successfully to /app/data/"
        volumeMounts:
        - name: config
          mountPath: /config
        - name: nfs-storage
          mountPath: /app/data
      {{- end }}
      containers:
      - name: {{ .Chart.Name }}
        image: {{ .Values.app.image }}
        imagePullPolicy: {{ .Values.app.imagePullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.app.containerPort }}
          protocol: TCP
        volumeMounts:
        - name: nfs-storage
          mountPath: /app/data
        env:
        - name: HOTEL_JSON_PATH
          value: "/app/data/hotel_rooms.json"
        livenessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      {{- if .Values.hotelRoomsJson.enabled }}
      - name: config
        configMap:
          name: {{ include "myhotel-app.fullname" . }}-hotel-rooms-json
      {{- end }}
      - name: nfs-storage
        persistentVolumeClaim:
          claimName: {{ include "myhotel-app.fullname" . }}-app-pvc

